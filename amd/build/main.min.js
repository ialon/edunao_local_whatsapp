define(["jquery","core/ajax","core/templates","core/str","qrcode"],(function(t,e,n,a,o){return{init:function(t,e,n,a,o){this.courseID=t,this.teachers=e,this.canManage=n,this.user=a,this.groupLink=o,this.contacts=this.teachers,this.user&&this.user.whatsapp_enable&&(this.contacts=this.teachers.concat(this.user)),this.groupLink&&this.groupLink.whatsapp_enable&&(this.contacts=this.contacts.concat(this.groupLink)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.moveMenuItem.bind(this)):this.moveMenuItem()},moveMenuItem:function(){let t=document.querySelector('li[data-key="whatsapp"] a');if(!t)return;let e=t.cloneNode(!0);e.removeAttribute("role"),e.removeAttribute("tabindex"),e.classList.remove("dropdown-item"),e.classList.add("btn","btn-sm","btn-info","float-right","align-items-center","ml-3"),e.style.height="fit-content",e.style.color="white",e.innerHTML='<i class="fa fa-whatsapp mr-2"></i> WhatsApp';let n="#28a745";0===this.contacts.length&&(n="#8f959e"),e.style.backgroundColor=n,e.style.borderColor=n;let a=document.querySelector(".page-header-headings");a&&a.parentNode.insertBefore(e,a.nextSibling),e.addEventListener("click",(t=>{t.preventDefault(),this.showModal()})),t.addEventListener("click",(t=>{t.preventDefault(),this.showModal()}))},showModal:async function(){if(document.getElementById("whatsappModal"))return void t("#whatsappModal").modal("show");this.contacts.length>0&&(this.contacts[0].active=!0);let e=await a.get_string("group_link_help","local_whatsapp"),o=await a.get_string("whatsapp_number_help","local_whatsapp");const i={courseID:this.courseID,groupLink:this.groupLink,groupLinkHelp:{text:e},whatsappNumberHelp:{text:o},contacts:this.contacts,hasTabs:this.contacts.length>1||this.contacts.length>0&&this.canManage,canManage:this.canManage,user:this.user};n.render("local_whatsapp/modal",i).done(function(e,a){let o=this;document.body.insertAdjacentHTML("beforeend",e),n.runTemplateJS(a),t("#whatsappModal").modal("show"),this.contacts.forEach((function(t){o.generateQRCode(t),o.addCopyEventListener(t)}))}.bind(this)).fail((function(t){console.error("Failed to render template",t)}))},generateQRCode:function(t){let e=document.getElementById("qrcode-"+t.type+"-"+t.id);new o(e,{text:t.whatsapp_link,width:256,height:256})},addCopyEventListener:function(e){button=document.getElementById("copy-contact-"+e.type+"-"+e.id+"-button"),button&&(console.log(e.whatsapp_link),button.addEventListener("click",(function(){navigator.clipboard.writeText(e.whatsapp_link).then((async function(){let e=await a.get_string("copied_clipboard","local_whatsapp");button.setAttribute("data-original-title",e),t(button).tooltip("show")})).catch((function(t){console.error("Could not copy text: ",t)})),button.addEventListener("mouseleave",(async function(){let e=await a.get_string("copy_clipboard","local_whatsapp");button.setAttribute("data-original-title",e),t(button).tooltip("hide")}),{once:!0})})))}}}));